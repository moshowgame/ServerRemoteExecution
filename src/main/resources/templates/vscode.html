<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>日志查看器</title>

    <!-- Bootstrap 5 CSS -->
    <link th:href="@{/static/bootstrap/5.3.2/css/bootstrap.min.css}" rel="stylesheet"/>
    <link th:href="@{/static/font-awesome/6.4.0/css/all.min.css}" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/static/bootstrap/5.3.2/css/bootstrap-icons.min.css}">

    <!-- CodeMirror -->
    <link rel="stylesheet" th:href="@{/static/codemirror/5.65.13/codemirror.min.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/idea.min.css" rel="stylesheet">
    <style>
        .CodeMirror { height: calc(100vh - 150px); border-left: 1px solid #ddd; }
        .timestamp { color: #008800; font-weight: bold; }
        .log-info { color: #0000FF; }
        .log-error { color: #FF0000; font-weight: bold; }
        .log-warn { color: #FFA500; }
        .log-debug { color: #888888; }
        .className { color: #660e7a; }
        .stacktrace { color: #666; }
        .number { color: #0000cc; }
        .highlight { background: #ff0; }
    </style>
</head>
<body>
<!-- 导航栏 -->
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-brand">日志查看器</span>
        <div class="d-flex">
            <div class="form-check form-switch text-light me-3">
                <input class="form-check-input" type="checkbox" id="autoScroll">
                <label class="form-check-label" for="autoScroll">自动滚动</label>
            </div>
            <div class="form-check form-switch text-light">
                <input class="form-check-input" type="checkbox" id="lineWrap">
                <label class="form-check-label" for="lineWrap">自动换行</label>
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row mt-3">
        <!-- 侧边栏 -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">日志文件列表</div>
                <div class="card-body p-0">
                    <div id="fileTree" class="list-group list-group-flush">
                        <!-- 文件列表将动态加载到这里 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 主编辑器区域 -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <p id="fileName"></p>
                </div>
                <div class="card-body p-0">
                    <textarea id="logEditor"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 脚本依赖 -->
<script th:src="@{/static/jquery/3.7.1/jquery.min.js}"></script>
<script th:src="@{/static/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/static/codemirror/5.65.13/codemirror.min.js}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/scroll/annotatescrollbar.js"></script>

<script th:inline="javascript">

    // 加载文件列表
    $(function() {
        const listUrl = /*[[ @{/list} ]]*/ '';
        const readUrl = /*[[ @{/read} ]]*/ '';
        const downloadUrl = /*[[ @{/download} ]]*/ '';
        const filePath = /*[[${filePath}]]*/ '';
        const parentPath = filePath.substring(0, filePath.lastIndexOf('\\'));
        const fileNameStr = filePath.substring(filePath.lastIndexOf('\\')+1,filePath.length);
        console.log(parentPath);

        $('#fileName').text(filePath);
        let editor = CodeMirror.fromTextArea(document.getElementById('logEditor'), {
                mode: "logHighlight",
                theme: "idea",
                lineNumbers: true,
                readOnly: true,
                lineWrapping: true,
                scrollbarStyle: "native"
            });
        // 自定义日志高亮模式
        CodeMirror.defineMode("logHighlight", function() {
            return {
                token: function(stream) {
                    // 时间戳
                    if (stream.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}/)) {
                        return "timestamp";
                    }
                    // 日志级别
                    if (stream.match(/^(INFO|DEBUG|ERROR|WARN|TRACE)/)) {
                        return "log-" + stream.current().toLowerCase();
                    }
                    // 错误堆栈
                    if (stream.match(/^\s+at .+/)) {
                        return "stacktrace";
                    }
                    // 数字
                    if (stream.match(/^[0-9]+/)) {
                        return "number";
                    }
                    stream.next();
                    return null;
                }
            };
        });
        // 调用 /list 接口获取文件列表
        $.ajax({
            url: listUrl,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ filePath: parentPath }),
            success: function(data) {
                const fileTree = $('#fileTree');
                data.data.forEach(file => {
                    if (!file.isDirectory){
                        console.log(file)
                        const fileItem = $('<a href="#" class="list-group-item list-group-item-action"></a>').text(file.name);
                        //if filename = filepath , add active class
                        if (file.name.trim() === fileNameStr.trim()) {
                            console.log("check active:",file.name,fileNameStr);
                            fileItem.addClass('active');


                        }
                        fileItem.click(function(e) {
                            e.preventDefault();
                            $('#fileTree a').removeClass('active');
                            $(this).addClass('active');
                            // 调用 /read 接口读取文件内容
                            $.ajax({
                                url: readUrl,
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({ filePath: file.path }),
                                success: function(logContent) {
                                    // editor.getDoc().setValue(logContent);
                                    $('#logEditor').html(logContent.data);
                                    editor.refresh();
                                },
                                error: function(error) {
                                    console.error('Error reading file:', error);
                                }
                            });
                        });
                        fileTree.append(fileItem);
                    }
                });
            },
            error: function(error) {
                console.error('Error loading file list:', error);
            }
        });

        // 自动换行切换
        $('#lineWrap').change(function() {
            editor.setOption('lineWrapping', this.checked);
        });

        // 搜索功能
        $('#searchInput').on('input', function() {
            const query = $(this).val();
            if (query) {
                editor.operation(function() {
                    for (let cursor = editor.getSearchCursor(query); cursor.findNext();) {
                        editor.markText(cursor.from(), cursor.to(), {
                            className: "highlight"
                        });
                    }
                });
            }
        });

        // 自动滚动
        let autoScroll = true;
        editor.on('change', () => {
            if (autoScroll) {
                editor.execCommand('goDocEnd');
            }
        });
        $('#autoScroll').change(function() {
            autoScroll = this.checked;
        });
    });
</script>
</body>
</html>